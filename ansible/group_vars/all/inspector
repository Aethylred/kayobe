---
###############################################################################
# Ironic inspector configuration.

# Ironic inspector IPMI username to set.
inspector_ipmi_username:

# Ironic inspector IPMI password to set.
inspector_ipmi_password:

# Ironic inspector deployment kernel location.
inspector_deploy_kernel:

# Ironic inspector deployment ramdisk location.
inspector_deploy_ramdisk:

###############################################################################
# Ironic inspector introspection rules configuration.

# Inspector rules use python string formatting. To escape a curly bracket we
# repeat it, but this also happens to be the Jinja2 variable start sequence.
# These variables make escaping rules slightly less hairy.
inspector_rule_escaped_left_curly: "{{ '{{' | replace('{{', '{{ \"{{\" }}') }}"
inspector_rule_escaped_right_curly: "{{ '}}' | replace('}}', '{{ \"}}\" }}') }}"

# Ironic inspector rule to set IPMI credentials.
inspector_rule_ipmi_credentials:
  description: "Set IPMI driver_info if no credentials"
  conditions:
    - field: "node://driver_info.ipmi_username"
      op: "is-empty"
    - field: "node://driver_info.ipmi_password"
      op: "is-empty"
  actions:
    - action: "set-attribute"
      path: "driver_info/ipmi_username"
      value: "{{ inspector_ipmi_username }}"
    - action: "set-attribute"
      path: "driver_info/ipmi_password"
      value: "{{ inspector_ipmi_password }}"

# Ironic inspector rule to set deployment kernel.
inspector_rule_deploy_kernel:
  description: "Set deploy kernel"
  conditions:
    - field: "node://driver_info.deploy_kernel"
      op: "is-empty"
  actions:
    - action: "set-attribute"
      path: "driver_info/deploy_kernel"
      value: "{{ inspector_deploy_kernel }}"

# Ironic inspector rule to set deployment ramdisk.
inspector_rule_deploy_ramdisk:
  description: "Set deploy ramdisk"
  conditions:
    - field: "node://driver_info.deploy_ramdisk"
      op: "is-empty"
  actions:
    - action: "set-attribute"
      path: "driver_info/deploy_ramdisk"
      value: "{{ inspector_deploy_ramdisk }}"

# Ironic inspector rule to set local boot capability
inspector_rule_local_boot:
  description: "Set local boot capability"
  conditions: []
  actions:
    - action: "set-capability"
      name: "boot_option"
      value: "local"

# Ironic inspector rule to initialise root device hints.
inspector_rule_root_hint_init:
  description: "Initialise root device hint"
  conditions:
    - field: "node://properties.root_device"
      op: "is-empty"
  actions:
    # Inspector can't combine references to introspection data with non-string
    # types, see https://bugs.launchpad.net/ironic-inspector/+bug/1670768. We
    # must therefore first set the root_device property to an empty dict, then
    # update the fields within it.
    - action: "set-attribute"
      path: "properties/root_device"
      value: {}

# Ironic inspector rule to set serial root device hint.
inspector_rule_root_hint_serial:
  description: "Set serial root device hint"
  conditions:
    - field: "data://root_disk.serial"
      op: "is-empty"
      invert: True
  actions:
    - action: "set-attribute"
      path: "properties/root_device/serial"
      value: "{data[root_disk][serial]}"

# Ironic inspector rule to set the interface on which the node PXE booted.
inspector_rule_set_pxe_interface_mac:
  description: "Set node PXE interface MAC address"
  conditions:
    - field: "data://boot_interface"
      op: "is-empty"
      invert: True
  actions:
    - action: "set-attribute"
      path: "extra/pxe_interface_mac"
      value: "{data[boot_interface]}"

# Ironic inspector rule to set the node's name from eno3's LLDP switch port
# description.
inspector_rule_eno3_lldp_switch_port_desc_to_name:
  description: "Set node name from LLDP switch port description"
  conditions:
    - field: "data://all_interfaces.eno3.lldp_processed.switch_port_description"
      op: "is-empty"
      invert: True
  actions:
    - action: "set-attribute"
      path: "name"
      value: "{data[all_interfaces][eno3][lldp_processed][switch_port_description]}"

# Ironic inspector rule to save introspection data to the node.
inspector_rule_save_data:
  description: "Save introspection data to Ironic node"
  conditions: []
  actions:
    - action: "set-attribute"
      path: "extra/introspection_data"
      value: "{data}"
